# 系统架构说明

**技术栈**：Cloudflare Workers + D1 + Pages  
**采样频率**：1 分钟  
**告警渠道**：飞书群机器人  
**AI 分析**：仅 CRIT 级别触发  
**当前版本**：v1（单品种 AU9999）

## 系统架构图

```
┌────────────┐      Cron(1m)      ┌──────────────────┐
│ Cloudflare │ ───────────────▶  │ Scheduled Worker │
│   Cron     │                   │                  │
└────────────┘                   │ - 拉金价         │
                                 │ - 写 D1          │
                                 │ - 算涨跌幅       │
                                 │ - 飞书告警       │
                                 │ - CRIT 调 AI     │
                                 └────────┬─────────┘
                                          │
                                D1 (SQLite-like)
                                          │
                   ┌──────────────────────┴──────────────────────┐
                   │                                             │
        ┌──────────────────┐                       ┌────────────────────┐
        │ API Worker       │                       │ Cloudflare Pages   │
        │                  │                       │ (前端页面)         │
        │ - prices API     │◀──── fetch ────────▶ │ - 金价曲线          │
        │ - trades API     │                       │ - 买卖点标注       │
        │ - reports API    │                       │ - AI 报告查看      │
        └──────────────────┘                       └────────────────────┘
```

## 核心组件

### 1. Scheduled Worker（定时任务）
- 每分钟执行一次
- 抓取国内金价（AU9999）
- 计算涨跌幅并触发告警
- CRIT 级别调用 AI 分析

### 2. API Worker（HTTP 接口）
- 提供价格查询接口
- 交易记录管理
- AI 报告查询
- 用户配置管理

### 3. Cloudflare Pages（前端）
- 价格走势图表
- 买卖点标注
- AI 分析报告展示
- 目标价管理

### 4. D1 数据库
- 价格分钟线数据
- 日线汇总数据
- 告警记录
- AI 分析报告
- 交易记录
- 用户配置

## 数据流向

1. **定时任务流**：Cron → Worker → 金价 API → D1 → 飞书
2. **用户查询流**：浏览器 → Pages → API Worker → D1 → 返回数据
3. **用户操作流**：浏览器 → Pages → API Worker → D1 → 保存数据

## 免费额度控制要点

### Worker
- 每分钟任务 ≤ 3 次 D1 查询
- AI 调用只在 CRIT 级别

### D1
- 禁止全表扫描
- 所有查询必须命中索引

### Pages
- 默认只拉最近 24 小时数据
- 支持最多 360 天历史查询

## v1 的刻意限制

- 只支持 `symbol = 'AU9999'`（国内金价）
- 不做多周期聚合（5m / 1h）
- 使用 Cloudflare Access 进行访问控制
- 不支持多告警渠道
